const run = async (steps = [], storeAdapter, config) => {
  const currentStep = await storeAdapter.currentStep({ config })
  let stepIndex
  for (stepIndex in steps) {
    if (stepIndex <= currentStep) {
      console.log(`Skipping step ${stepIndex}`)
      continue
    }
    console.log(`Running step ${stepIndex}`)
    const step = steps[stepIndex]
    for (let entry of step.actions) {
      await storeAdapter.applyStepEntry({ entry, config }).catch(async err => {
        await storeAdapter.handleStepError(err)
      })
    }
  }
  if (parseInt(stepIndex) !== currentStep) {
    await storeAdapter.logStepComplete({ stepIndex, config })
    console.log(`Finished at step ${stepIndex}`)
  }
  storeAdapter.close({ config })
}

module.exports = run
