const path = require('path')
const APP_PATH = process.env.APP_PATH || `${__dirname}/../skel`

const api = require(path.resolve(APP_PATH, 'back/api.json'))
const config = require(path.resolve(APP_PATH, 'back.config.js'))

const configsLoaded = {}
const configName = process.env.CONFIG_NAME || 'development'

module.exports = async (storeName = 'primary') => {
  if (configsLoaded[storeName]) {
    return configsLoaded[storeName]
  } else if (config[configName] && config[configName][storeName].loader) {
    const loader = require(`./configLoaders/${config[configName][storeName].loader}`)
    const configLoaded = await loader(config[configName][storeName].params)
    configsLoaded[storeName] = { ...configLoaded, ...{ storeName }, api } // eslint-disable-line require-atomic-updates
    return configsLoaded[storeName]
  } else {
    configsLoaded[storeName] = {
      ...config[configName][storeName],
      ...{ storeName },
      api
    }
    return configsLoaded[storeName]
  }
}
