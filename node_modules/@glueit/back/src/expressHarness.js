const paths = require('./paths')
const express = require('express')
const bodyParser = require('body-parser')

const buildRouter = api => {
  const router = express.Router()
  let base = ''
  if (api.back && api.back.base) {
    base = api.back.base
  }
  const expressMiddleware = (method, path, handler) => {
    const wrapper = async (request, response) => {
      const context = {
        request,
        response,
        headers: request.headers,
        path: request.path,
        body: undefined,
        status: undefined
      }
      await handler(context).catch(e => {
        response.status(500).send(e.message) // TODO: Improve for dev and production obfuscate
      })
      if (context.body || context.status) {
        response.status(context.status || 200).send(context.body)
      }
    }
    if (base !== '') {
      const subRouter = express.Router()
      router.use(base, subRouter[method](path, wrapper))
    } else {
      router[method](path, wrapper)
    }
  }

  paths(api.paths, expressMiddleware)
  return router
}

module.exports = ({ api }) => {
  const router = buildRouter(api)
  return [
    bodyParser.json({ limit: '10mb', extended: false }),
    bodyParser.urlencoded({ extended: false }),
    router
  ]
}
