const assert = require('assert')
const { verify } = require('../jwt')

module.exports = async ({ context, pathDefn, store }) => {
  let isAuthorized = false
  try {
    if (pathDefn.back.authorize === false) {
      return true
    }

    const authorizationHeader = context.headers['authorization']
    assert(authorizationHeader)

    const token = authorizationHeader.substring(
      'Bearer '.length,
      authorizationHeader.length
    )
    const { email } = verify(token)
    assert(email)

    const users = await store.get({ name: 'users', query: { email } })
    const user = users[0]
    assert(user)

    // TODO: add active
    // const { active } = user
    // assert(active)

    context.user = user // eslint-disable-line require-atomic-updates
    isAuthorized = true
  } catch (e) {
    context.status = 401 // eslint-disable-line require-atomic-updates
  }
  return isAuthorized
}
