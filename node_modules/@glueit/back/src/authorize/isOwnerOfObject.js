const assert = require('assert')

module.exports = async ({ context, store, name, idName, id, object }) => {
  let isAuthorized = false
  try {
    let fieldName = 'userId'
    if (name === 'users') {
      fieldName = 'id'
    }
    if (id) {
      const item = await store.get({ name, idName, id, query: {} })
      assert(item[fieldName] === context.user.id)
    } else {
      assert(Array.isArray(object))
      for (let objectItem of object) {
        const item = await store.get({
          name,
          idName,
          id: objectItem.id,
          query: {}
        })
        assert(item[fieldName] === context.user.id)
      }
    }

    isAuthorized = true
  } catch (e) {
    context.status = 401 // eslint-disable-line require-atomic-updates
  }
  return isAuthorized
}
