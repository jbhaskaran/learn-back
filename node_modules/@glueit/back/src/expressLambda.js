const express = require('express')
const awsServerlessExpress = require('aws-serverless-express')
const expressHarness = require('./expressHarness')
const apiDefinition = require('./apiDefinition')
const storeConfig = require('./storeConfig')
const storeInit = require('./storeInit')

let storeAdapter = null

const app = express()
const server = awsServerlessExpress.createServer(
  app.use(expressHarness({ api: apiDefinition }))
)

module.exports = (event, context) => {
  if (storeAdapter) {
    awsServerlessExpress.proxy(server, event, context)
  } else {
    storeConfig().then(config => {
      storeAdapter = storeInit(config)
      awsServerlessExpress.proxy(server, event, context)
    })
    return null
  }
}
